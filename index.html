<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <title>Đăng Ký Làm Đại Lý</title>
  </head>
  <body>
    <div class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Đang xử lý...</div>
    </div>

    <div class="banner">
      <img class="banner-img" src="assets/img/banner.png" alt="Banner" />
    </div>

    <div class="container">
      <form id="agentForm" onsubmit="return validateForm(event)" novalidate>
        <div class="form-header">
          <h2>Đăng Ký Làm Đại Lý</h2>
        </div>

        <div class="form-section personal-info-section">
          <div class="form-row">
            <div class="form-group">
              <label for="fullName">Họ và Tên</label>
              <input
                type="text"
                id="fullName"
                name="fullName"
                placeholder="Nhập họ tên"
              />
              <div class="error-message" id="fullNameError"></div>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="Nhập email"
              />
              <div class="error-message" id="emailError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phone">Số Điện Thoại</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="Nhập số điện thoại"
              />
              <div class="error-message" id="phoneError"></div>
            </div>
            <div class="form-group">
              <label for="taxCode">Mã Số Thuế</label>
              <input
                type="text"
                id="taxCode"
                name="taxCode"
                placeholder="Nhập mã số thuế"
              />
              <div class="error-message" id="taxCodeError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="idNumber">Số CCCD/CMND</label>
              <input
                type="text"
                id="idNumber"
                name="idNumber"
                placeholder="Nhập số CCCD/CMND"
              />
              <div class="error-message" id="idNumberError"></div>
            </div>
            <div class="form-group">
              <label for="agentType">Loại hình đại lý đăng ký:</label>
              <div class="select-wrapper">
                <select id="agentType" name="agentType">
                  <option value="">-- Chọn loại hình --</option>
                  <option value="individual">Cá nhân</option>
                  <option value="pharmacy">Nhà thuốc</option>
                  <option value="clinic">Phòng khám</option>
                  <option value="chain">Chuỗi</option>
                  <option value="supplier">Nhà cung cấp</option>
                  <option value="hospital">Bệnh viện</option>
                </select>
              </div>
              <div class="error-message" id="agentTypeError"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="position">Chức vụ:</label>
              <input
                type="text"
                id="position"
                name="position"
                placeholder="Nhập chức vụ"
              />
              <div class="error-message" id="positionError"></div>
            </div>
            <div class="form-group">
              <label for="address">Địa Chỉ</label>
              <input
                type="text"
                id="address"
                name="address"
                placeholder="Nhập địa chỉ"
              />
              <div class="error-message" id="addressError"></div>
            </div>
          </div>

          <div class="form-group full-width text-area-group">
            <label style="color: red"
              >Lưu ý quan trọng về giấy tờ cần thiết của từng loại đại lý
              *</label
            >
            <textarea
              id="importantNotes"
              name="importantNotes"
              rows="7"
              readonly
            ></textarea>
          </div>
        </div>

        <div class="form-section document-upload-section">
          <div class="form-row">
            <div class="form-group file-upload-group">
              <label>Ảnh CCCD/CMND:</label>
              <div class="drop-zone-container">
                <div class="drop-zone-wrapper">
                  <div class="cBoxDrop">
                    <label for="cccdFront">Mặt trước CCCD/CMND</label>
                    <div class="drop-zone" id="cccdFrontDropZone">
                      <input
                        type="file"
                        id="cccdFront"
                        name="cccdFront"
                        accept="image/*"
                        hidden
                      />
                      <div class="drop-zone-content">
                        <img
                          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'/%3E%3Cpolyline points='17 8 12 3 7 8'/%3E%3Cline x1='12' y1='3' x2='12' y2='15'/%3E%3C/svg%3E"
                          alt="Upload"
                          class="upload-icon"
                        />
                        <p>
                          Kéo thả file hoặc
                          <span class="browse-text">chọn file</span>
                        </p>
                        <p class="note">Định dạng: JPG, PNG (Tối đa 5MB)</p>
                      </div>
                      <div class="image-preview" id="cccdFrontPreview"></div>
                    </div>
                    <div class="file-list" id="cccdFrontFileList"></div>
                    <div class="error-message" id="cccdFrontError"></div>
                  </div>

                  <div class="cBoxDrop">
                    <label for="cccdBack">Mặt sau CCCD/CMND</label>
                    <div class="drop-zone" id="cccdBackDropZone">
                      <input
                        type="file"
                        id="cccdBack"
                        name="cccdBack"
                        accept="image/*"
                        hidden
                      />
                      <div class="drop-zone-content">
                        <img
                          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'/%3E%3Cpolyline points='17 8 12 3 7 8'/%3E%3Cline x1='12' y1='3' x2='12' y2='15'/%3E%3C/svg%3E"
                          alt="Upload"
                          class="upload-icon"
                        />
                        <p>
                          Kéo thả file hoặc
                          <span class="browse-text">chọn file</span>
                        </p>
                        <p class="note">Định dạng: JPG, PNG (Tối đa 5MB)</p>
                      </div>
                      <div class="image-preview" id="cccdBackPreview"></div>
                    </div>
                    <div class="file-list" id="cccdBackFileList"></div>
                    <div class="error-message" id="cccdBackError"></div>
                  </div>
                </div>
                <button type="button" class="ekyc-button" onclick="openEKYC()">
                  <i class="fas fa-id-card"></i> Xác thực eKYC
                </button>
              </div>
            </div>
          </div>

          <div class="form-group full-width file-upload-group">
            <label for="otherDocs">Các loại giấy tờ khác:</label>
            <div class="drop-zone-k" id="otherDocsDropZone">
              <input
                type="file"
                id="otherDocs"
                name="otherDocs"
                accept=".pdf,.jpg,.png"
                multiple
                hidden
              />
              <div class="drop-zone-content">
                <img
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'/%3E%3Cpolyline points='17 8 12 3 7 8'/%3E%3Cline x1='12' y1='3' x2='12' y2='15'/%3E%3C/svg%3E"
                  alt="Upload"
                  class="upload-icon"
                />
                <p>
                  Kéo thả file vào đây hoặc
                  <span class="browse-text">chọn file</span>
                </p>
                <p class="note">Định dạng: PDF, JPG, PNG (Tối đa 10MB)</p>
              </div>
              <div class="image-preview-grid" id="otherDocsPreview"></div>
            </div>
            <div class="file-list" id="otherDocsFileList"></div>
            <div class="error-message" id="otherDocsError"></div>
          </div>
        </div>

        <div class="form-section note-and-submit-section">
          <button type="submit" class="submit-button">Gửi đơn ngay</button>
        </div>
      </form>
    </div>

    <div class="footer-info">
      <div class="footer-logo">
        <a href="https://doppelherz.vn/">
          <img
            src="assets/icon/icon_home.svg"
            alt="Doppelherz Logo"
            class="footer-logo-img"
          />
        </a>
      </div>
      <div class="footer-social">
        <a
          href="https://www.facebook.com/DoppelherzVietnam"
          class="social-icon"
        >
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="https://www.youtube.com/DoppelherzVn1" class="social-icon">
          <i class="fab fa-youtube"></i>
        </a>
        <a href="https://www.instagram.com/doppelherz.vn/" class="social-icon">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://zalo.me/4609946806172836027" class="social-icon">
          <p style="color: #ffff; font-size: 16px">Zalo</p>
        </a>
      </div>
      <div class="footer-copyright">
        <div><i class="fas fa-copyright"></i> Doppelherz Việt Nam 2025</div>
        <div><i class="fas fa-phone"></i> 18001770</div>
      </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Modal for image preview -->
    <div id="imagePreviewModal" class="image-preview-modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <img id="previewImage" src="" alt="Preview" />
      </div>
    </div>

    <script>
      // Đối tượng chứa nội dung lưu ý cho từng loại đại lý
      const agentNotes = {
        "": "Chọn loại hình đại lý để xem lưu ý về giấy tờ.",
        individual:
          "- Giấy tờ cá nhân: CCCD/CMND (mặt trước và sau), ảnh chân dung.\n- Giấy phép kinh doanh (nếu có).\n- Xác nhận nơi cư trú.",
        pharmacy:
          "- Giấy phép kinh doanh nhà thuốc.\n- Chứng chỉ hành nghề dược của chủ nhà thuốc.\n- CCCD/CMND của chủ nhà thuốc.\n- Danh sách nhân viên (nếu có).",
        hospital:
          "- Giấy phép hoạt động bệnh viện.\n- Giấy phép kinh doanh (nếu có).\n- Danh sách bác sĩ và chứng chỉ hành nghề.\n- CCCD/CMND của người đại diện pháp luật.",
        supplier:
          "- Giấy phép kinh doanh.\n- Giấy chứng nhận đăng ký doanh nghiệp.\n- CCCD/CMND của người đại diện pháp luật.\n- Giấy chứng nhận đủ điều kiện sản xuất/kinh doanh.\n- Danh sách sản phẩm cung cấp.",
        chain:
          "- Giấy phép kinh doanh của công ty mẹ.\n- Giấy chứng nhận đăng ký doanh nghiệp.\n- CCCD/CMND của người đại diện pháp luật.\n- Danh sách các chi nhánh.\n- Quyết định thành lập chi nhánh.",
        clinic:
          "- Giấy phép hoạt động phòng khám.\n- Giấy phép kinh doanh.\n- Chứng chỉ hành nghề của bác sĩ.\n- CCCD/CMND của người đại diện pháp luật.\n- Danh sách nhân viên y tế.",
      };

      // Cập nhật nội dung lưu ý khi chọn loại hình đại lý
      document.addEventListener("DOMContentLoaded", () => {
        const agentTypeSelect = document.getElementById("agentType");
        const importantNotesTextarea =
          document.getElementById("importantNotes");

        // Set initial content
        importantNotesTextarea.value = agentNotes[agentTypeSelect.value];

        agentTypeSelect.addEventListener("change", function () {
          importantNotesTextarea.value = agentNotes[this.value];
          this.blur(); // Tự động tắt focus sau khi chọn option
        });
      });

      // Thêm hàm hiển thị thông báo
      function showNotification(message, type = "success", time = 3000) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add("show");

        // Tự động ẩn sau thời gian được chỉ định
        setTimeout(() => {
          notification.classList.remove("show");
        }, time);
      }

      // Hàm xử lý kéo thả file
      function setupDropZone(dropZoneId, inputId, fileListId) {
        const dropZone = document.getElementById(dropZoneId);
        const input = document.getElementById(inputId);
        const fileList = document.getElementById(fileListId);
        const previewId = inputId + "Preview";
        const preview = document.getElementById(previewId);
        const dropZoneContent = dropZone.querySelector(".drop-zone-content");

        // Xử lý sự kiện kéo thả
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Thêm hiệu ứng khi kéo file vào
        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
          dropZone.classList.add("highlight");
        }

        function unhighlight(e) {
          dropZone.classList.remove("highlight");
        }

        // Xử lý khi thả file
        dropZone.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          input.files = files;
          handleFiles(files);
        }

        // Xử lý khi click vào vùng kéo thả
        dropZone.addEventListener("click", (e) => {
          // Chỉ mở dialog chọn file khi click vào vùng trống hoặc drop zone content
          if (e.target === dropZone || e.target.closest(".drop-zone-content")) {
            input.click();
          }
        });

        // Xử lý khi chọn file
        input.addEventListener("change", function () {
          if (this.files.length > 0) {
            handleFiles(this.files);
          }
        });

        function handleFiles(files) {
          const fileList = document.getElementById(inputId + "FileList");
          const previewGrid = document.getElementById(inputId + "Preview");
          const dropZoneContent = document.querySelector(
            `#${inputId}DropZone .drop-zone-content`
          );
          const fileInput = document.getElementById(inputId);

          // Ẩn drop zone content khi bắt đầu thêm file mới
          dropZoneContent.style.display = "none";

          // Xóa file cũ nếu là CCCD/CMND
          if (inputId === "cccdFront" || inputId === "cccdBack") {
            fileList.innerHTML = "";
            previewGrid.innerHTML = "";
          }

          [...files].forEach((file) => {
            // Nếu là CCCD/CMND và đã có file, bỏ qua file mới
            if (
              (inputId === "cccdFront" || inputId === "cccdBack") &&
              fileList.children.length > 0
            ) {
              return;
            }

            const fileItem = document.createElement("div");
            fileItem.className = "file-item";
            fileItem.innerHTML = `
              <span class="file-name">${file.name}</span>
              <span class="file-size">${formatFileSize(file.size)}</span>
              <button type="button" class="remove-file" onclick="event.stopPropagation(); removeFile(this, '${inputId}', '${
              file.name
            }')">×</button>
            `;
            fileList.appendChild(fileItem);

            // Hiển thị preview cho ảnh và PDF
            if (file.type.startsWith("image/")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const previewItem = document.createElement("div");
                previewItem.className = "preview-item";
                previewItem.dataset.filename = file.name;
                previewItem.innerHTML = `
                  <img src="${e.target.result}" alt="Preview" onclick="event.stopPropagation(); openImagePreview(this.src)">
                  <button type="button" class="remove-preview" onclick="event.stopPropagation(); removePreviewItem(this, '${inputId}', '${file.name}')">×</button>
                `;
                previewGrid.appendChild(previewItem);
                previewGrid.classList.add("show");
              };
              reader.readAsDataURL(file);
            } else if (file.type === "application/pdf") {
              const reader = new FileReader();
              reader.onload = function (e) {
                const previewItem = document.createElement("div");
                previewItem.className = "preview-item";
                previewItem.dataset.filename = file.name;
                previewItem.innerHTML = `
                  <div class="file-icon" onclick="event.stopPropagation(); openPDFPreview('${e.target.result}')">
                    <i class="fas fa-file-pdf"></i>
                    <span class="file-name">${file.name}</span>
                  </div>
                  <button type="button" class="remove-preview" onclick="event.stopPropagation(); removePreviewItem(this, '${inputId}', '${file.name}')">×</button>
                `;
                previewGrid.appendChild(previewItem);
                previewGrid.classList.add("show");
              };
              reader.readAsDataURL(file);
            }
          });
        }
      }

      // Hàm định dạng kích thước file
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Hàm xóa preview item
      function removePreviewItem(button, inputId, filename) {
        event.stopPropagation(); // Ngăn chặn sự kiện click lan truyền
        const previewItem = button.parentElement;
        const previewGrid = previewItem.parentElement;
        previewGrid.removeChild(previewItem);

        // Xóa file item tương ứng
        const fileList = document.getElementById(inputId + "FileList");
        const fileItems = fileList.getElementsByClassName("file-item");
        for (let item of fileItems) {
          const fileName = item.querySelector(".file-name").textContent;
          if (fileName === filename) {
            fileList.removeChild(item);
            break;
          }
        }

        // Reset input file
        const fileInput = document.getElementById(inputId);
        fileInput.value = "";

        // Chỉ hiển thị lại drop zone content khi không còn file nào
        if (
          previewGrid.children.length === 0 &&
          fileList.children.length === 0
        ) {
          previewGrid.classList.remove("show");
          const dropZone = document.getElementById(inputId + "DropZone");
          const dropZoneContent = dropZone.querySelector(".drop-zone-content");
          dropZoneContent.style.display = "flex";
        }
      }

      // Hàm xóa file
      function removeFile(button, inputId, filename) {
        event.stopPropagation(); // Ngăn chặn sự kiện click lan truyền
        const fileItem = button.parentElement;
        const fileList = fileItem.parentElement;
        fileList.removeChild(fileItem);

        // Xóa preview tương ứng
        const previewGrid = document.getElementById(inputId + "Preview");
        const previewItems = previewGrid.getElementsByClassName("preview-item");
        for (let item of previewItems) {
          if (item.dataset.filename === filename) {
            previewGrid.removeChild(item);
            break;
          }
        }

        // Reset input file
        const fileInput = document.getElementById(inputId);
        fileInput.value = "";

        // Chỉ hiển thị lại drop zone content khi không còn file nào
        if (
          previewGrid.children.length === 0 &&
          fileList.children.length === 0
        ) {
          previewGrid.classList.remove("show");
          const dropZone = document.getElementById(inputId + "DropZone");
          const dropZoneContent = dropZone.querySelector(".drop-zone-content");
          dropZoneContent.style.display = "flex";
        }
      }

      // Khởi tạo các vùng kéo thả
      setupDropZone("cccdFrontDropZone", "cccdFront", "cccdFrontFileList");
      setupDropZone("cccdBackDropZone", "cccdBack", "cccdBackFileList");
      setupDropZone("otherDocsDropZone", "otherDocs", "otherDocsFileList");

      // Hàm scroll mượt tới element
      function smoothScrollTo(element) {
        const headerOffset = 100; // Offset để tránh bị che bởi header
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition =
          elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
          top: offsetPosition,
          behavior: "smooth",
        });

        // Focus vào input sau khi scroll
        setTimeout(() => {
          const input = element.querySelector("input, select, textarea");
          if (input) {
            input.focus();
          }
        }, 500); // Delay 500ms để đợi scroll hoàn thành
      }

      // Hàm validate form
      function validateForm(event) {
        event.preventDefault();
        let isValid = true;
        let firstError = null;

        // Hàm hiển thị lỗi
        function showError(elementId, message) {
          const inputElement = document.getElementById(elementId);
          const errorElement = document.getElementById(elementId + "Error");
          const formGroup = inputElement?.closest(".form-group");

          if (formGroup && errorElement) {
            formGroup.classList.add("error");
            errorElement.textContent = message;
            errorElement.style.display = "block";

            // Lưu lỗi đầu tiên để scroll tới
            if (!firstError) {
              firstError = formGroup;
            }
          }
        }

        // Hàm ẩn lỗi
        function hideError(elementId) {
          const inputElement = document.getElementById(elementId);
          const errorElement = document.getElementById(elementId + "Error");
          const formGroup = inputElement?.closest(".form-group");

          if (formGroup && errorElement) {
            formGroup.classList.remove("error");
            errorElement.style.display = "none";
          }
        }

        // Xóa tất cả các thông báo lỗi cũ
        document.querySelectorAll(".form-group").forEach((group) => {
          const input =
            group.querySelector("input") || group.querySelector("textarea");
          const radio = group.querySelector('input[type="radio"]');
          if (input && input.id) {
            hideError(input.id);
          } else if (radio && radio.name) {
            hideError(radio.name);
          }
        });

        // Validate Full Name
        const fullName = document.getElementById("fullName").value.trim();
        if (!fullName) {
          showError("fullName", "Vui lòng nhập họ và tên!");
          isValid = false;
        } else if (fullName.length < 2) {
          showError("fullName", "Họ và tên phải có ít nhất 2 ký tự!");
          isValid = false;
        } else {
          // Kiểm tra viết hoa chữ đầu của mỗi từ
          const nameWords = fullName.split(" ");
          const hasInvalidCapitalization = nameWords.some((word) => {
            // Bỏ qua các từ đặc biệt như "de", "van", "von", "le", "la", "di", "da"
            const specialWords = ["de", "van", "von", "le", "la", "di", "da"];
            if (specialWords.includes(word.toLowerCase())) return false;

            // Kiểm tra chữ cái đầu tiên của mỗi từ
            return word.charAt(0) !== word.charAt(0).toUpperCase();
          });

          if (hasInvalidCapitalization) {
            showError(
              "fullName",
              "Vui lòng viết hoa chữ cái đầu của mỗi từ trong họ tên!"
            );
            isValid = false;
          } else {
            hideError("fullName");
          }
        }

        // Validate Email
        const email = document.getElementById("email").value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
          showError("email", "Vui lòng nhập email!");
          isValid = false;
        } else if (!emailRegex.test(email)) {
          showError("email", "Email không đúng định dạng!");
          isValid = false;
        }

        // Validate Phone
        const phone = document.getElementById("phone").value.trim();
        const phoneRegex = /^0\d{9}$/;
        if (!phone) {
          showError("phone", "Vui lòng nhập số điện thoại!");
          isValid = false;
        } else if (!phoneRegex.test(phone)) {
          showError(
            "phone",
            "Số điện thoại phải bắt đầu bằng số 0 và có đúng 10 chữ số!"
          );
          isValid = false;
        } else {
          hideError("phone");
        }

        // Validate Tax Code
        const taxCode = document.getElementById("taxCode").value.trim();
        const taxCodeRegex = /^(\d{10}|\d{13})$/;
        if (!taxCode) {
          showError("taxCode", "Vui lòng nhập mã số thuế!");
          isValid = false;
        } else if (!taxCodeRegex.test(taxCode)) {
          showError("taxCode", "Mã số thuế phải có 10 hoặc 13 chữ số!");
          isValid = false;
        }

        // Validate ID Number
        const idNumber = document.getElementById("idNumber").value.trim();
        const idNumberRegex = /^(\d{9}|\d{12})$/;
        if (!idNumber) {
          showError("idNumber", "Vui lòng nhập số CCCD/CMND!");
          isValid = false;
        } else if (!idNumberRegex.test(idNumber)) {
          showError("idNumber", "Số CCCD/CMND phải có 9 hoặc 12 chữ số!");
          isValid = false;
        } else {
          hideError("idNumber");
        }

        // Validate Agent Type (Select dropdown)
        const agentTypeSelect = document.getElementById("agentType");
        const agentType = agentTypeSelect.value;

        if (!agentType) {
          showError("agentType", "Vui lòng chọn loại hình đại lý đăng ký!");
          isValid = false;
        } else {
          hideError("agentType");
        }

        // Validate Position
        const position = document.getElementById("position").value.trim();
        if (!position) {
          showError("position", "Vui lòng nhập chức vụ!");
          isValid = false;
        } else if (position.length < 2) {
          showError("position", "Chức vụ phải có ít nhất 2 ký tự!");
          isValid = false;
        }

        // Validate Address
        const address = document.getElementById("address").value.trim();
        if (!address) {
          showError("address", "Vui lòng nhập địa chỉ!");
          isValid = false;
        } else if (address.length < 5) {
          showError("address", "Địa chỉ phải có ít nhất 5 ký tự!");
          isValid = false;
        }

        // Validate ID Card
        const cccdFrontFiles = document.getElementById("cccdFront").files;
        const cccdBackFiles = document.getElementById("cccdBack").files;

        if (cccdFrontFiles.length === 0) {
          showError("cccdFront", "Vui lòng tải lên ảnh mặt trước CCCD/CMND!");
          isValid = false;
        } else {
          for (let file of cccdFrontFiles) {
            if (file.size > 5 * 1024 * 1024) {
              // 5MB
              showError(
                "cccdFront",
                "Kích thước file không được vượt quá 5MB!"
              );
              isValid = false;
              break;
            }
            if (!["image/jpeg", "image/png"].includes(file.type)) {
              showError("cccdFront", "Chỉ chấp nhận file ảnh JPG hoặc PNG!");
              isValid = false;
              break;
            }
          }
        }

        if (cccdBackFiles.length === 0) {
          showError("cccdBack", "Vui lòng tải lên ảnh mặt sau CCCD/CMND!");
          isValid = false;
        } else {
          for (let file of cccdBackFiles) {
            if (file.size > 5 * 1024 * 1024) {
              // 5MB
              showError("cccdBack", "Kích thước file không được vượt quá 5MB!");
              isValid = false;
              break;
            }
            if (!["image/jpeg", "image/png"].includes(file.type)) {
              showError("cccdBack", "Chỉ chấp nhận file ảnh JPG hoặc PNG!");
              isValid = false;
              break;
            }
          }
        }

        // Validate Other Docs (nếu có)
        const otherDocsFiles = document.getElementById("otherDocs").files;
        if (otherDocsFiles.length > 0) {
          for (let file of otherDocsFiles) {
            if (file.size > 10 * 1024 * 1024) {
              // 10MB
              showError(
                "otherDocs",
                "Kích thước file tài liệu khác không được vượt quá 10MB!"
              );
              isValid = false;
              break;
            }
            if (
              !["application/pdf", "image/jpeg", "image/png"].includes(
                file.type
              )
            ) {
              showError(
                "otherDocs",
                "Chỉ chấp nhận file PDF, JPG hoặc PNG cho tài liệu khác!"
              );
              isValid = false;
              break;
            }
          }
        }

        if (isValid) {
          // Tạo object chứa dữ liệu form
          const formData = {
            fullName: document.getElementById("fullName").value.trim(),
            email: document.getElementById("email").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            taxCode: document.getElementById("taxCode").value.trim(),
            idNumber: document.getElementById("idNumber").value.trim(),
            agentType: document.getElementById("agentType").value,
            position: document.getElementById("position").value.trim(),
            address: document.getElementById("address").value.trim(),
            files: {
              cccdFront:
                document.getElementById("cccdFront").files[0]?.name ||
                "Không có file",
              cccdBack:
                document.getElementById("cccdBack").files[0]?.name ||
                "Không có file",
              otherDocs: Array.from(
                document.getElementById("otherDocs").files
              ).map((file) => file.name),
            },
          };

          // Log dữ liệu ra console
          console.log("=== DỮ LIỆU ĐĂNG KÝ ĐẠI LÝ ===");
          console.log("Thông tin cá nhân:", {
            "Họ và tên": formData.fullName,
            Email: formData.email,
            "Số điện thoại": formData.phone,
            "Mã số thuế": formData.taxCode,
          });
          console.log("Thông tin đại lý:", {
            "Loại hình đại lý": formData.agentType,
            "Chức vụ": formData.position,
            "Địa chỉ": formData.address,
          });
          console.log("Tài liệu đính kèm:", formData.files);
          console.log("===========================");

          // Hiển thị loading overlay
          const loadingOverlay = document.querySelector(".loading-overlay");
          loadingOverlay.classList.add("active");

          // Chuyển đổi FormData thành JSON
          const jsonData = {
            fullName: document.getElementById("fullName").value.trim(),
            email: document.getElementById("email").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            taxCode: document.getElementById("taxCode").value.trim(),
            idNumber: document.getElementById("idNumber").value.trim(),
            agentType: document.getElementById("agentType").value,
            position: document.getElementById("position").value.trim(),
            address: capitalizeWords(
              document.getElementById("address").value.trim()
            ),
          };

          // Hàm viết hoa chữ cái đầu của mỗi từ
          function capitalizeWords(str) {
            // Danh sách các từ không cần viết hoa
            const specialWords = [
              "phường",
              "quận",
              "huyện",
              "thị xã",
              "thành phố",
              "tỉnh",
              "số",
              "đường",
              "phố",
              "ngõ",
              "ngách",
              "tổ",
              "khu",
              "khối",
            ];

            // Tách chuỗi thành các từ
            return str
              .split(" ")
              .map((word) => {
                // Nếu từ nằm trong danh sách đặc biệt, giữ nguyên
                if (specialWords.includes(word.toLowerCase())) {
                  return word.toLowerCase();
                }
                // Viết hoa chữ cái đầu, viết thường các chữ cái còn lại
                return (
                  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                );
              })
              .join(" ");
          }

          fetch("https://reqres.in/api/users", {
            method: "POST",
            body: JSON.stringify(jsonData),
            headers: {
              "Content-Type": "application/json",
              "x-api-key": "reqres-free-v1",
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              console.log("API Response:", data);
              // Chỉ hiển thị thông báo thành công và reset form khi API trả về thành công
              showNotification(
                "Dữ liệu đã được gửi thành công, chúng tôi sẽ gửi gửi hợp đồng điện tử vào email của bạn sau ít phút.",
                "success",
                5000
              );
              // Reset form
              document.getElementById("agentForm").reset();
              document.getElementById("cccdFrontFileList").innerHTML = "";
              document.getElementById("cccdBackFileList").innerHTML = "";
              document.getElementById("otherDocsFileList").innerHTML = "";
            })
            .catch((error) => {
              console.error("Error:", error);
              showNotification(
                "Có lỗi xảy ra khi gửi dữ liệu. Vui lòng thử lại sau.",
                "error"
              );
            })
            .finally(() => {
              // Ẩn loading overlay
              loadingOverlay.classList.remove("active");
            });
        } else {
          // Nếu có lỗi, scroll tới lỗi đầu tiên
          if (firstError) {
            smoothScrollTo(firstError);
          }
          showNotification(
            "Vui lòng kiểm tra và điền đầy đủ các trường thông tin!",
            "error"
          );
        }

        return isValid;
      }

      // Hàm mở giao diện eKYC
      function openEKYC() {
        // Thay thế bằng SDK của nhà cung cấp eKYC
        // Ví dụ với một SDK giả định:
        const ekycConfig = {
          apiKey: "YOUR_API_KEY",
          onSuccess: handleEKYCSuccess,
          onError: handleEKYCError,
          language: "vi",
        };

        // Gọi SDK eKYC
        // EKYCProvider.initialize(ekycConfig);
        // EKYCProvider.startVerification();
      }

      // Xử lý kết quả eKYC thành công
      function handleEKYCSuccess(data) {
        // Điền thông tin vào form
        if (data.idNumber) {
          document.getElementById("idNumber").value = data.idNumber;
        }
        if (data.fullName) {
          document.getElementById("fullName").value = data.fullName;
        }
        if (data.address) {
          document.getElementById("address").value = data.address;
        }
        if (data.dob) {
          document.getElementById("dob").value = data.dob;
        }

        // Hiển thị thông báo thành công
        showNotification("Xác thực eKYC thành công!", "success");
      }

      // Xử lý lỗi eKYC
      function handleEKYCError(error) {
        console.error("eKYC Error:", error);
        showNotification("Xác thực eKYC thất bại. Vui lòng thử lại!", "error");
      }

      // Hàm mở preview ảnh
      function openImagePreview(src) {
        const modal = document.getElementById("imagePreviewModal");
        const previewImage = document.getElementById("previewImage");
        previewImage.src = src;
        modal.style.display = "block";
      }

      // Đóng modal khi click vào nút đóng
      document
        .querySelector(".close-modal")
        .addEventListener("click", function () {
          document.getElementById("imagePreviewModal").style.display = "none";
        });

      // Đóng modal khi click bên ngoài ảnh
      document
        .getElementById("imagePreviewModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
          }
        });

      // Đóng modal khi nhấn phím ESC
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          document.getElementById("imagePreviewModal").style.display = "none";
        }
      });

      // Hàm mở preview PDF
      function openPDFPreview(pdfData) {
        const modal = document.getElementById("imagePreviewModal");

        // Thay đổi nội dung modal để hiển thị PDF
        modal.querySelector(".modal-content").innerHTML = `
          <span class="close-modal">&times;</span>
          <div id="pdfContainer" style="width: 90vw; height: 90vh; overflow: auto; display: flex; justify-content: center; align-items: center;"></div>
        `;

        modal.style.display = "block";

        // Khởi tạo PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        // Load PDF
        pdfjsLib
          .getDocument(pdfData)
          .promise.then(function (pdf) {
            const container = document.getElementById("pdfContainer");
            container.innerHTML = ""; // Clear container

            // Render first page
            pdf.getPage(1).then(function (page) {
              // Tính toán scale dựa trên kích thước container
              const containerWidth = container.clientWidth - 40; // Trừ padding
              const containerHeight = container.clientHeight - 40;
              const viewport = page.getViewport({ scale: 1 });

              // Tính toán scale để PDF vừa với container
              const scaleX = containerWidth / viewport.width;
              const scaleY = containerHeight / viewport.height;
              const scale = Math.min(scaleX, scaleY);

              const scaledViewport = page.getViewport({ scale: scale });

              const canvas = document.createElement("canvas");
              const context = canvas.getContext("2d");
              canvas.height = scaledViewport.height;
              canvas.width = scaledViewport.width;

              const renderContext = {
                canvasContext: context,
                viewport: scaledViewport,
              };

              page.render(renderContext).promise.then(function () {
                // Tạo wrapper div để căn giữa canvas
                const wrapper = document.createElement("div");
                wrapper.style.display = "flex";
                wrapper.style.justifyContent = "center";
                wrapper.style.alignItems = "center";
                wrapper.style.width = "100%";
                wrapper.style.height = "100%";
                wrapper.appendChild(canvas);
                container.appendChild(wrapper);
              });
            });
          })
          .catch(function (error) {
            console.error("Error loading PDF:", error);
            const container = document.getElementById("pdfContainer");
            container.innerHTML = `
            <div style="color: white; text-align: center; padding: 20px;">
              Không thể hiển thị PDF. <a href="${pdfData}" download style="color: #4CAF50; text-decoration: underline;">Nhấn vào đây để tải xuống</a>
            </div>
          `;
          });

        // Thêm lại event listener cho nút đóng
        modal
          .querySelector(".close-modal")
          .addEventListener("click", function () {
            modal.style.display = "none";
            // Reset lại nội dung modal về trạng thái ban đầu
            modal.querySelector(".modal-content").innerHTML = `
            <span class="close-modal">&times;</span>
            <img id="previewImage" src="" alt="Preview">
          `;
          });
      }
    </script>
  </body>
</html>
